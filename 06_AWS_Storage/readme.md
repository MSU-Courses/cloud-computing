# Хранилища в облаке

## Вступление

В эпоху быстрых темпов роста данных и облачных вычислений, надежное и масштабируемое хранение информации стало ключевым фактором успеха IT-систем.

- Как эволюционировали системы хранения данных и с какими ограничениями сталкивались традиционные подходы?
- Что такое облачное хранилище и как виртуализация позволяет эффективно управлять данными?
- Какие виды хранилищ предлагает AWS и чем отличаются объектное, блочное и файловое хранилища?
- Как выбрать подходящий сервис – Amazon S3, EBS или EFS – для конкретных задач и типов данных?

В этой главе мы ответим на эти вопросы.

Мы рассмотрим теоретическую базу хранения данных, от традиционных моделей до облачной виртуализации, проследим развитие сервисов хранения в AWS и подробно познакомимся с тремя основными сервисами: Amazon S3 (объектное хранилище), Amazon EBS (блочное хранилище) и Amazon EFS (файловое хранилище). Особое внимание уделяется Amazon S3 как фундаментальному облачному хранилищу в AWS. По итогам изучения главы вы сможете уверенно ориентироваться в видах облачных хранилищ и понимать, какой сервис наиболее уместен для тех или иных практических сценариев.

## Эволюция хранения данных и вызовы традиционных моделей

Исторически первые системы хранения данных представляли собой локальные диски и ленты, установленные напрямую на серверах (так называемое _DAS — Direct-Attached Storage_). По мере роста объемов информации организации переходили к сетевым хранилищам — например, файловым серверам (NAS) или сетям хранения (SAN), которые позволяли централизованно управлять данными и обеспечивать доступ с разных устройств к хранилищам по сети. Однако традиционные модели хранения сталкивались с рядом проблем.

_Масштабирование_ означало дорогостоящую покупку дополнительного оборудования и сложное перенастроение инфраструктуры. Типичная проблема заключалась в том, что масштабировать такие системы _вертикально_ (увеличивая емкость или мощность существующих устройств) дорого и имеет пределы, а _горизонтальное_ масштабирование (добавление новых серверов или массивов) сопряжено с высокой сложностью управления данными и риском потери производительности. Кроме того, традиционные системы часто требовали дорогостоящего специализированного оборудования и были склонны к неэффективному использованию ресурсов — _значительные объемы дискового пространства могли простаивать невостребованными_, пока другие серверы испытывали дефицит.

Другой вызов – _отказоустойчивость и надежность_. В локальных хранилищах выход из строя оборудования (диска, контроллера) мог привести к потере данных, поэтому компаниям приходилось внедрять резервирование (_RAID_ - это когда несколько дисков работают вместе, чтобы обеспечить избыточность данных или _резервные серверы_) и регулярное резервное копирование (backup) для защиты от сбоев. Это увеличивало сложность и стоимость владения. Традиционные хранилища хорошо работают при относительно стабильных и предсказуемых нагрузках, но с большими объемами неструктурированных данных (например, архивы изображений, видео) они начинают сталкиваться с проблемами масштабируемости и производительности.

Таким образом, к середине 2000-х IT-индустрия нуждалась в новом подходе к хранению данных, который бы решал проблемы ограниченной масштабируемости, высокой стоимости, сложности резервирования и территориальной непривязанности. Эти предпосылки подготовили почву для появления облачных хранилищ.

## Облачное хранилище и виртуализация

_Облачное хранилище_ представляет собой модель хранения, при которой данные сохраняются на сторонних распределенных инфраструктурах и предоставляются пользователю как услуга по сети (обычно через интернет). Пользователь _работает с хранилищем как с бесконечно расширяемым ресурсом_, не заботясь о физических носителях, месте их размещения и обслуживании. Ключевую роль в этом играет _виртуализация хранения_ - процесс абстрагирования физических ресурсов хранения и предоставления их в виде логических единиц, которые можно легко масштабировать, управлять и использовать по требованию [^2]. Иными словами, провайдер облака берет на себя роль администратора множества дисков и серверов, объединяя их в единое пул ресурсов, а клиенту предоставляет виртуальные единицы хранения нужного типа и размера.

Виртуализация принесла ряд преимуществ:

- _Гибкость и масштабируемость_. Можно за секунды запросить больше места или увеличить производительность без покупки нового оборудования;
- _Высокая доступность и надежность_. Облачный провайдер распределяет данные по разным устройствам, а зачастую и разным дата-центрам, обеспечивая автоматическое резервирование и тем самым повышая сохранность данных;
- _Оплата по потреблению_. Отсутствует необходимость в крупных капитальных затратах на хранилище, вместо этого платишь за реально используемый объем и операции.

Облачное хранилище также обеспечивает глобальную доступность данных: пользователи могут получать к ним доступ из любой точки мира через интернет, а провайдер может автоматически доставлять контент ближе к пользователю (например, с помощью CDN).

## Уровни виртуализации хранилищ

Существует три основных подхода к организации хранения данных, которые соответствуют разным уровням абстракции: _блочное_, _файловое_ и _объектное_ хранилище.

> Данные хранилища были рассмотрены в _Главе 2. Архитектура облачных систем и основы виртуализации_

Кратко напомним их особенности:

- _Блочное хранилище_ (Block Storage). Данные разбиваются на фиксированные блоки, которые могут быть независимо адресованы и управляемы. _Блок_ – это условно кусочек (несколько килобайт или мегабайт) непрерывных данных на диске. Сервер обращается к блочному устройству (диску) по номерам блоков. Примером блочного хранилища служит жесткий диск или SSD: операционная система видит “диск” и может форматировать его в файловую систему. Блочное хранилище удобно для случаев, когда нужны низкие задержки и произвольный доступ – базы данных, файловые системы и т.д
- _Файловое хранилище_ (File Storage). Этот уровень знаком всем пользователям – данные организованы в виде файлов, сгруппированных по папкам (каталогам). _Файловое хранилище_ предполагает, что у нас есть общая файловая система, к которой могут подключаться несколько клиентов по сети.
- _Объектное хранилище_ (Object Storage). Данные сохраняются в виде объектов, каждый из которых содержит сам файл, метаданные и уникальный идентификатор. Объектное хранилище оптимизировано для хранения больших объемов неструктурированных данных (например, фото, видео, резервные копии) и обеспечивает высокую масштабируемость и доступность. В отличие от блочного и файлового хранилищ, объектное хранилище не использует иерархическую структуру папок, что упрощает управление большими объемами данных.

## Хранилища в AWS. История и обзор

Amazon Web Services запустилась в середине 2000-х как облачная платформа, и одним из первых сервисов, ставших ее фундаментом, было хранилище данных. _Amazon S3_ (Simple Storage Service) дебютировал в марте 2006 года, став первым облачным сервисом AWS, доступным широкой публике. По словам основателей, S3 решал на тот момент главную проблему хранения – безопасное и масштабируемое сохранение данных с полной ответственностью провайдера за надежность [^4].

Несколько месяцев спустя, в августе 2006, AWS запустила сервис облачных вычислений EC2, но ему не хватало постоянного дискового хранилища – виртуальные машины EC2 изначально имели только временные локальные диски, которые теряли данные при остановке экземпляра. Поэтому через два года, в августе 2008, был представлен Amazon EBS (Elastic Block Store) – сеть-хранилище блоков, позволяющее подключать постоянные диски к экземплярам EC2. EBS обеспечивал высокую производительность и низкие задержки, что делало его идеальным для баз данных и файловых систем.

Долгое время AWS предлагал только объектное хранилище (S3) и блочные тома (EBS), а для организации совместного доступа к файловым системам пользователи вынуждены были разворачивать свои собственные решения на базе EC2. Это изменилось в 2015 году с запуском Amazon EFS (Elastic File System) – полностью управляемого сервиса файлового хранилища, который позволяет нескольким экземплярам EC2 одновременно монтировать одну и ту же файловую систему.

Сегодня AWS предлагает широкий спектр сервисов хранения, охватывающих все три уровня виртуализации: объектное (S3), блочное (EBS) и файловое (EFS) хранилища, а также специализированные решения для архивирования (S3 Glacier) и гибридного хранения (AWS Storage Gateway). Эти сервисы стали краеугольным камнем инфраструктуры многих компаний, позволяя им эффективно управлять данными в облаке.

## Основные категории хранилищ в AWS

_Основные категории хранилищ в AWS_ соответствуют упомянутым уровням организации данных:

- _Amazon Elastic Block Store (EBS)_. Сервис блочного хранения. Предоставляет сетевые виртуальные диски для Amazon EC2 (виртуальных машин). С EBS вы создаете том (volume) заданного размера и типа и подключаете его к своему экземпляру EC2, как обычный диск.
- _Amazon Elastic File System (EFS)_. Распределенная файловая система. Это полностью управляемый сервис, предоставляющий файловое хранилище, к которому могут одновременно подключаться несколько серверов (EC2 или даже локальные серверы через VPN).
- _Amazon Simple Storage Service (S3)_. Масштабируемое объектное хранилище. Позволяет сохранять данные в виде объектов в бакетах через веб-интерфейс или API. Поддерживает практически неограниченный объем данных и предлагает различные классы хранения для оптимизации затрат.

Следует отметить, что AWS также предлагает дополнительные решения для хранения и переноса данных: сервис AWS Storage Gateway для интеграции локальных систем с облаком, Amazon FSx для специализированных файловых систем (например, Windows File Server или Lustre).

## Amazon S3

_Amazon S3 (Simple Storage Service)_ – это облачный сервис объектного хранилища, предназначенный для хранения и получения любых объемов данных через веб-интерфейс. S3 не является прикладным приложением (SaaS) или платформой (PaaS), а относится к категории инфраструктуры как услуги (IaaS), предоставляя базовые ресурсы хранения, которые пользователи могут использовать для своих приложений.

> В отличии от того же Google Drive или Dropbox, которые являются SaaS решениями, предоставляющими готовые приложения для хранения и обмена файлами, Amazon S3 предоставляет инфраструктуру для хранения данных, которую разработчики могут интегрировать в свои собственные приложения и сервисы. Грубо говоря, на базе S3 можно построить свое собственное Dropbox или Google Drive.

### Архитектура и общие понятия

В хранилище S3 данные хранятся в контейнерах, которые называются _бакетами_ (англ. _bucket_).

_Бакет_ - это логический контейнер для хранения объектов (файлов). Каждый бакет имеет уникальное имя по всему миру (глобальное пространство имен). Нельзя создать бакет с именем, которое уже занято другим пользователем AWS, даже в другом регионе.

Название бакета должно удовлетворять определенным правилам (_naming conventions_):

1. только маленькие буквы, цифры, дефисы и точки
2. не должно быть IP-адресом (например, 192.168.5.1)
3. длина от 3 до 63 символов
4. начинаться и заканчиваться буквой или цифрой
5. не содержать подчеркиваний, точек подряд или дефисов в начале/конце

> _Хорошие названия_: `my-company-data`, `photos-2024`, `backup-archive`;
>
> _Плохие названия_: `MyCompanyData` (заглавные буквы), `photos..2024` (точки подряд), `-backup-archive-` (дефисы в начале/конце).

_Объект_ в S3 - это единица хранения, которая содержит:

- _непосредственно данные_ (например, файл)
- _метаданные_ (дополнительную информацию: содержимое, тип файла, дату загрузки и т.д.),

Каждый объект идентифицируется уникальным ключом (имя файла) внутри бакета. Например, если у вас есть бакет `my-usm-photos` и вы загружаете файл `vacation.jpg`, полный путь к объекту будет `my-usm-photos/vacation.jpg` [^5].

Бакет можно представить как аналог корневой директории: в него можно помещать сколько угодно объектов, и у объектов могут быть ключи с “псевдо-папками” (например, `2024-usm/January/photo1.jpg`, `2024-usm` - бакет, `January` - псевдо-папка внутри бакета, `photo1.jpg` - объект), но на самом деле *в S3 нет настоящих па*пок – это просто часть ключа объекта, создающая иерархию для удобства навигации.

### Региональность и доступ

Сам _S3 является глобальным сервисом_. Но, каждый _бакет привязан к региону AWS_, т.е. физически данные хранятся в дата-центрах определенного региона (например, EU (Frankfurt) или us-east-1 (N. Virginia)).

_S3 обеспечивает чрезвычайно высокую надежность_ за счет хранения данных сразу в нескольких зонах доступности внутри региона: для стандартных классов хранения объект автоматически дублируется не менее чем на трех зонах доступности (AZ). Это реализует дизайн с так называемой _11 9s durability_ (11 девяток надежности), тот есть сервис спроектирован на долговечность данных _99.999999999%_ в год. Проще говоря, _вероятность потерять объект в S3 крайне мала_ – система постоянно проверяет целостность данных и при сбое оборудования восстанавливает копии с уцелевших носителей [^6].

_Доступность_ (шанс в любой момент времени получить доступ к объекту) для стандартного хранилища S3 гарантируется на уровне 99.99%, что означает, что в среднем _сервис может быть недоступен не более 52 минут в год_.

> За высокую надежность и доступность S3 расплачивается тем, что задержки доступа могут быть выше, чем к локальному диску, однако для большинства сценариев (особенно чтения больших файлов, раздачи контента пользователям) это не критично.

### Неограниченная емкость

S3 предоставляет практически неограниченное пространство. Вы можете _загружать объекты размером до 5 ТБ_ каждый, а количество объектов не лимитировано. Общий объем ограничен лишь бюджетом. Такая масштабируемость реализована за счет того, что AWS распределяет объекты по множеству узлов хранения.

### Доступ к объекту S3

Каждый объект S3 доступен по уникальному URL. Формат URL зависит от стиля обращения к бакету. Есть два основных способа:

- _Virtual-hosted–style URL_. Рекомендуемый формат, когда имя бакета включается в доменное имя хоста.
  - Например, объект с ключом _photo.png_ в бакете _mybucket_ (регион us-west-2) будет доступен по адресу:
    ```
    https://mybucket.s3.us-west-2.amazonaws.com/photo.png
    ```
- _Path-style URL_. Устаревающий формат, когда имя бакета идет как первый сегмент пути URL после стандартного хоста региона.
  - Например, тот же объект будет доступен по адресу:
    ```
    https://s3.us-west-2.amazonaws.com/mybucket/photo.png
    ```

В настоящее время path-style URL объявлен к постепенному прекращению поддержки (для новых бакетов), и AWS рекомендует использовать virtual-hosted стиль [^7].

### Использование и сценарии хранения

Перед началом использования S3 важно понимать, какие данные и для каких целей можно хранить в этом сервисе. S3 идеально подходит для хранения:

- _Статического контента сайтов и приложений_. Например, HTML, CSS, JavaScript, изображения, видео. S3 часто выступает в роли хранилища для статических веб-сайтов.
- _Резервных копий и архивов_. Благодаря высокой надежности и доступности, S3 часто используется для хранения бэкапов серверов, баз данных и других критичных данных.
- _Больших данных и data lakes_. S3 может хранить огромные объемы неструктурированных данных, которые затем анализируются с помощью других сервисов AWS.
- _Пользовательского контента_. Например, фотографии, аватарки и видео, загружаемые пользователями приложений. S3 масштабируется автоматически, поэтому подходит для сервисов с миллионами пользователей.

Перед выбором S3 важно учитывать простое правило: если ваши данные _не требуют низких задержек доступа_ (как в случае с базами данных) и _не нуждаются в частых изменениях_ (S3 оптимизирован для операций чтения и записи, но не для частых обновлений), то S3 может быть отличным выбором.

### Версионирование объектов

S3 поддерживает версионирование на уровне бакета. Если включить версионирование, каждый раз при перезаписи или удалении объекта старые версии не удаляются насовсем, а сохраняются с отдельными version ID. Это означает, что можно восстановить предыдущую версию файла, если текущая была случайно перезаписана или удалена

### Шифрование данных

В S3 реализованы многоуровневые возможности шифрования. Во-первых, все соединения к S3 осуществляются по HTTPS, поэтому данные в транзите шифруются. Во-вторых, S3 может автоматически шифровать объекты при сохранении (шифрование на стороне сервера) с помощью различных алгоритмов (например, AES-256). 

### Классы хранения в S3

Одно из мощных возможностей S3 – поддержка разных _классов хранения для объектов_. В зависимости от характера ваших данных вы можете выбрать один из классов для каждого объекта (или настроить правила, автоматически перемещающие объекты между классами).

Ниже приведена таблица с основными классами S3 и их предназначением:

| **Класс хранения S3**                  | **Назначение и особенности**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | **Примеры использования**                                                                                                                                                                                                                                                                                                                               |
| -------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **S3 Standard** (стандартный)          | _Класс по умолчанию_. Предназначен для часто запрашиваемых (часто используемых) данных. Обеспечивает наивысшую производительность, репликацию минимум в трех AZ и доступность 99.99%. Подходит для активных данных приложений, веб-сайтов, мобильных приложений – всего, к чему нужен быстрый доступ без задержек. Стоимость хранения в этом классе самая высокая, зато нет дополнительных задержек на доступ. Пример: пользовательские фотографии в активном приложении, актуальные документы.                                   | Активно используемые данные: контент веб-сайтов, мобильных приложений, часто запрашиваемые документы, актуальные базы данных (например, экспорты), промежуточные результаты вычислений.                                                                                                                                                                 |
| **S3 Standard-IA** (Infrequent Access) | Для редко запрашиваемых данных, которые при этом должны быть быстро доступны при обращении. _IA_ хранит данные в ≥3 AZ, имеет такую же 11-9s надежность. **Доступность** слегка ниже (99.9%). Существенно более низкая цена за GB хранения (~в 2 раза дешевле Standard), но взимается плата за чтение объектов (за каждый GB или 1000 запросов) и требуется минимальный период хранения 30 дней и минимальный размер объекта (например, объект <128KB все равно оплачивается как 128KB).                                          | Данные, к которым обращаются редко (несколько раз в месяц или реже), но они должны сразу отдаваться: резервные копии, архивы журналов за прошлые периоды, старые медиафайлы пользователей, которые могут изредка скачиваться.                                                                                                                           |
| **S3 One Zone-IA**                     | Похож на _Standard-IA_, но хранит данные только в одной AZ (зоне). Это дает еще меньшую цену хранения, но снижает устойчивость к катастрофам: если выйдет из строя весь дата-центр, данные могут пропасть. Долговечность внутри зоны все еще высокая (AWS заявляет 11 9s, но уже в пределах AZ, а не региона). Этот класс подходит для вторичных копий данных или данных, потеря которых не критична либо у вас есть резерв в другом месте.                                                                                       | Архивы, легко восстанавливаемые из других источников; сгенерированные преобразуемые данные, которые можно воссоздать; резервные копии, имеющие другие копии в разных регионах. В целом, использовать One Zone-IA имеет смысл только если вы можете допустить потерю данных в случае катастрофы в дата-центре или у вас есть дублирующее резервирование. |
| **S3 Intelligent-Tiering**             | Умный класс, который автоматически оптимизирует стоимость хранения в зависимости от активности доступа. AWS будет мониторить, как часто вы обращаетесь к объектам, и перемещать их между двумя уровнями: _Frequent Access_ и _Infrequent Access_ внутри этого класса. Если данные не запрашиваются 30 дней, объект переводится на более дешевое хранение для infrequent access; если потом снова начнут часто читать – вернется на Frequent. Преимущество – вам не нужно вручную управлять классами для непредсказуемых нагрузок. |
| **S3 Glacier**                         | Класс _архивного хранения_. Данные хранятся с минимальной стоимостью, но не предназначены для оперативного доступа. Когда вы помещаете объект в класс Glacier, прямой возможности сразу скачать его нет – сначала нужно инициировать восстановление (restore), которое занимает время.                                                                                                                                                                                                                                            | Электронные архивы документов, резервные копии, требующие оперативного доступа в случае инцидента (например, актуальные бэкапы системы, которые почти никогда не запрашиваются, но если понадобятся – нужно быстро восстановить); медицинские или юридические архивы, которые запрашиваются по особым случаям.                                          |
| **S3 Glacier Deep Archive**            | Самый дешевый архивный класс, рассчитанный на крайне редко запрашиваемые данные. Стоимость хранения в 2–3 раза ниже Glacier, но восстановление занимает часы (по стандарту 12+ часов) и ограниченные опции                                                                                                                                                                                                                                                                                                                        | Долговременное архивирование и законодательное хранение данных, которые, возможно, никогда не будут запрошены: финансовая отчетность более 7 летней давности, архивы научных данных, резервные копии системы перед выводом из эксплуатации, которые сохраняются «на всякий случай».                                                                     |

Все классы, кроме One Zone-IA, хранят копии данных как минимум в трех независимых AZ в пределах одного региона, поэтому гарантируют сохранность даже при выходе из строя целого дата-центра.

S3 легко позволяет управлять классами хранения. Часто используют политику жизненного цикла (Lifecycle policy): например, хранить загруженный объект 30 дней в Standard, потом автоматически перевести в Standard-IA, а через год в Glacier. Такие политики помогают минимизировать затраты на хранение без потери доступности нужных данных [^5].

[^1]: _Object storage vs traditional storage: key differences_. nebius [online]. Available at: https://nebius.com/blog/posts/what-is-object-storage-vs-block-storage
[^2]: _What is virtualization?_. ibm.com [online]. Available at: https://www.ibm.com/think/topics/virtualization
[^3]: _Story of AWS Storage_. medium.com [online]. Available at: https://medium.com/@sumbul.first/story-of-aws-storage-3d1934c1a336
[^4]: _Our Origins_. aws.amazon.com [online]. Available at: https://aws.amazon.com/ru/about-aws/our-origins/
[^5]: _AWS Storage Showdown: EBS, S3, and EFS Explained_. exam-labs.com [online]. Available at: https://www.exam-labs.com/blog/aws-storage-showdown-ebs-s3-and-efs-explained
[^6]: _Data protection in Amazon S3_. docs.aws.amazon.com [online]. Available at: https://docs.aws.amazon.com/AmazonS3/latest/userguide/DataDurability.html
[^7]: _Virtual hosting of general purpose buckets_. docs.aws.amazon.com [online]. Available at: https://docs.aws.amazon.com/AmazonS3/latest/userguide/VirtualHosting.html
