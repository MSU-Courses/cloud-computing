# Безсерверные вычисления. AWS Lambda

## Вопросы для самопроверки

1. После изучения данной лекции студент должен уметь ответить на следующие вопросы:
2. Чем отличается концепция serverless от традиционной серверной архитектуры и в каких случаях целесообразно использовать каждый подход?
3. Как работает событийно-ориентированная модель AWS Lambda и какие источники событий могут запускать выполнение функций?
4. Каковы основные ограничения AWS Lambda и как они влияют на проектирование приложений?
5. Как правильно конфигурировать Lambda-функцию, включая настройку памяти, времени выполнения и роли выполнения?

## Введение в Serverless Computing

### Традиционный подход к разработке приложений

Когда мы разрабатываем веб-приложение традиционным способом, нам необходимо заботиться не только о самом коде приложения, но и об инфраструктуре, на которой оно будет работать. Представьте, что вы открываете ресторан: _вам нужно не только готовить еду, но и арендовать помещение_, покупать оборудование, следить за его состоянием, оплачивать электричество и воду - даже когда ресторан закрыт и посетителей нет.

Аналогично, в традиционной архитектуре разработчики должны [^1]:

- Выбирать и настраивать серверы (физические или виртуальные).
- Устанавливать и обновлять операционную систему.
- Настраивать сетевую инфраструктуру.
- Масштабировать серверы при увеличении нагрузки.
- Обеспечивать безопасность и резервное копирование.
- Оплачивать серверы круглосуточно, независимо от фактической нагрузки.

### Концепция Serverless Computing

_Serverless computing_ (безсерверные вычисления) - это модель облачных вычислений, при которой провайдер облачных услуг автоматически управляет инфраструктурой, необходимой для выполнения кода. Важно понимать, что название "serverless" несколько вводит в заблуждение - серверы все еще существуют, просто разработчику не нужно о них беспокоиться [^2] [^3].

Возвращаясь к аналогии с рестораном: вместо того чтобы открывать собственное заведение, вы становитесь шеф-поваром, который готовит блюда только когда приходит заказ. Всю инфраструктуру - кухню, оборудование, уборку, коммунальные платежи - берет на себя кто-то другой. Вы платите только за время, которое потратили на приготовление блюд.

Не нужно путать Serverless Computing с

### Основные характеристики концепции Serverless

Serverless computing обладает рядом ключевых характеристик, которые отличают его от традиционных подходов:

- _Событийно-ориентированная модель_. Код выполняется только в ответ на определенные события - HTTP-запрос, загрузка файла, изменение в базе данных. Между событиями ваш код не потребляет ресурсы.
- _Автоматическое масштабирование_. Если одновременно приходит одно событие или тысяча, платформа автоматически выделяет необходимое количество ресурсов для их обработки.
- _Оплата за фактическое использование_. Вы платите только за время выполнения кода, измеряемое в миллисекундах, а не за время, когда сервер простаивает.
- _Отсутствие управления серверами_. Провайдер полностью берет на себя обслуживание, масштабирование, обновление и обеспечение отказоустойчивости инфраструктуры.
- _Stateless-выполнение_. Каждый вызов функции является независимым и _не сохраняет состояние между вызовами_. Если нужно сохранить данные, используются внешние сервисы хранения.

### Serverless vs Server: ключевые различия

Сравним детально традиционный серверный подход и безсерверные вычисления [^4]:

| Характеристика             | Традиционная (Server)                                       | Serverless                                    |
| -------------------------- | ----------------------------------------------------------- | --------------------------------------------- |
| Управление инфраструктурой | Разработчик настраивает и управляет серверами               | Провайдер полностью управляет инфраструктурой |
| Масштабирование            | Требуется ручная настройка или предварительная конфигурация | Автоматическое, мгновенное                    |
| Модель оплаты              | Оплата за зарезервированные мощности (24/7)                 | Оплата только за время выполнения кода        |
| Время простоя              | Серверы работают постоянно, даже без нагрузки               | Ресурсы выделяются только при необходимости   |
| Холодный старт             | Отсутствует (сервер всегда готов)                           | Возможна задержка при первом запросе          |
| Гибкость конфигурации      | Полный контроль над окружением                              | Ограниченные возможности настройки            |

### Преимущества и недостатки Serverless Computing

Безсерверные вычисления предлагают множество преимуществ, но также имеют и свои ограничения. Рассмотрим основные из них:

| Преимущества                                                                                                                                                                                    | Недостатки                                                                                                                                                                                                                                          |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| _Повышение производительности разработчиков_. Освобожденные от задач администрирования серверов, разработчики могут сосредоточиться на написании бизнес-логики и создании функциональности      | _Проблема холодного старта_. При первом вызове функции после периода простоя требуется время на инициализацию окружения, что может составлять от 100 миллисекунд до нескольких секунд. Это критично для приложений, требующих минимальных задержек. |
| _Сокращение операционных расходов_. Отсутствие необходимости оплачивать простаивающие серверы значительно снижает затраты, особенно для приложений с нерегулярной или непредсказуемой нагрузкой | _Vendor lock-in_. Переход на другого провайдера может потребовать значительной переработки кода из-за использования специфичных API и сервисов                                                                                                      |
| _Быстрый вывод на рынок_. Упрощенный процесс развертывания позволяет быстрее внедрять новые функции и исправлять ошибки.                                                                        | _Ограниченная кастомизация_. Вы не можете полностью контролировать окружение выполнения - доступны только те опции, которые предоставляет платформа.                                                                                                |
| _Встроенная отказоустойчивость_. Облачные провайдеры обеспечивают высокую доступность и автоматическое восстановление после сбоев.                                                              | _Сложность отладки и мониторинга_. Распределенная природа serverless-приложений усложняет отслеживание ошибок и анализ производительности                                                                                                           |
| _Автоматическая масштабируемость_. Приложение может обрабатывать как единичные запросы, так и миллионы одновременных событий без ручной настройки.                                              | _Ограничения времени выполнения_. Serverless-функции обычно имеют максимальное время выполнения (например, 15 минут в AWS Lambda), что делает их непригодными для длительных задач.                                                                 |

> Serverless не заменяет традиционные архитектуры полностью. Многие организации используют гибридный подход, комбинируя serverless для определенных задач с традиционными серверами для других компонентов системы [^5]s

## AWS Lambda. Введение и основные концепции

### Что такое AWS Lambda?

_AWS Lambda_ - это полностью управляемый сервис безсерверных вычислений от Amazon Web Services, который _позволяет запускать код без необходимости создания и управления серверами_. Lambda была представлена в 2014 году и стала пионером в области Function-as-a-Service (FaaS) [^5].

Простыми словами, AWS Lambda позволяет загружать свой код, написанный на разных языках программирования, и выполнять его автоматически - когда происходит определённое событие или в заданное время, _не заботясь о серверной инфраструктуре_.

Lambda часто называют _функциями_, потому что здесь вы создаёте небольшие, независимые участки кода, каждый из которых выполняет одну конкретную задачу. Когда происходит нужное событие, эта функция запускается, выполняет свою работу и завершает выполнение. После этого ресурсы автоматически освобождаются, поэтому вам не нужно постоянно поддерживать работающий сервер.

AWS Lambda автоматически масштабируется для обработки от нескольких запросов в день до тысяч запросов в секунду. Вы загружаете свой код, а Lambda берет на себя все необходимое для его выполнения и масштабирования с высокой доступностью [^5].

### Назначение AWS Lambda

Lambda предназначена для решения широкого спектра задач:

- _Обработка данных в реальном времени_. Анализ потоковых данных, обработка логов, мониторинг метрик.
- _Обработка файлов_. Автоматическое создание миниатюр изображений, конвертация видео, обработка документов при загрузке в S3.
- _Бэкенд для веб и мобильных приложений_. Обработка API-запросов, аутентификация пользователей, интеграция с базами данных.
- _Пакетная обработка данных_. Генерация отчетов, агрегация данных.
- _Автоматизация инфраструктуры_. Автоматический запуск и остановка EC2 инстансов по расписанию, резервное копирование, управление ресурсами.
- _IoT-приложения_. Обработка событий от IoT-устройств, маршрутизация сообщений, реагирование на изменения состояния.

Таким образом, Lambda используется для выполнения кода в ответ на события, особенно когда задачи не требуют длительных вычислений и не потребляют много ресурсов.

### Масштабируемость AWS Lambda

_AWS Lambda_ является _региональным сервисом_, что означает, что функции создаются и хранятся в конкретном AWS-регионе. Понимание этой архитектуры важно для проектирования отказоустойчивых и производительных приложений [^6].

Когда вы создаете Lambda-функцию, вы выбираете регион, в котором она будет размещена. _Код функции, конфигурация и логи хранятся в этом регионе_. AWS автоматически реплицирует вашу функцию в нескольких зонах доступности (Availability Zones) внутри выбранного региона для обеспечения высокой доступности. Это значит, что даже если одна зона доступности выйдет из строя, ваша функция останется доступной через другие зоны.

_Что это означает на практике_:

- _Низкая задержка_. Размещайте Lambda-функции в том же регионе, где находятся ресурсы, с которыми они взаимодействуют (S3, DynamoDB, RDS и т.д.), чтобы минимизировать задержки при вызовах.
- _Соответствие требованиям_. Некоторые законодательства требуют, чтобы данные оставались в определенной географической зоне.
- _Отказоустойчивость_. Lambda автоматически распределяет нагрузку между зонами доступности в регионе.
- _Стоимость_. Передача данных между регионами тарифицируется, поэтому размещение в одном регионе экономически выгоднее.

> По умолчанию есть ограничение в _1000 одновременных выполнений Lambda-функций_ на регион. Это мягкое ограничение, которое можно увеличить, обратившись в AWS Support, если ваше приложение требует большего масштаба.

### Событийно-ориентированная модель AWS Lambda

Ключевая особенность Lambda заключается в том, что _функции запускаются только при наличии триггера_ - определенного события. Это отличает Lambda от традиционных серверов, которые работают постоянно в ожидании запросов.

Представьте датчик движения, который включает свет только когда кто-то проходит мимо. Lambda работает аналогично: _ваш код "спит" и не потребляет ресурсы до тех пор, пока не произойдет событие, которое его активирует_.

Такой подход имеет несколько важных последствий:

- _Экономия ресурсов_. Нет необходимости держать серверы запущенными в ожидании запросов.
- _Автоматическое масштабирование_. Lambda автоматически создает столько экземпляров функции, сколько необходимо для обработки входящих событий.
- _Изоляция_. Каждый вызов функции обрабатывается независимо, что повышает надежность системы.

### AWS Lambda, как функция

В контексте AWS Lambda _функция_ - это базовая единица развертывания и выполнения. Это фрагмент кода, который выполняет конкретную задачу в ответ на событие.

Важно понимать различие между функцией как концепцией программирования и Lambda-функцией:

- _Функция в программировании_ - это блок кода, который может быть вызван из других частей программы.
- _Lambda-функция_ - это полноценное приложение, включающее код, зависимости, конфигурацию и права доступа.

Каждая _Lambda-функция_ имеет:

- _Handler (обработчик)_ - точка входа, метод, который Lambda вызывает для начала выполнения вашего кода.
- _Runtime (среда выполнения)_ - языковое окружение, в котором выполняется код. Например, Node.js, Python, Java, Go и другие.
- _Execution role (роль выполнения)_ - IAM-роль, определяющая разрешения функции. Например, доступ к S3, DynamoDB и другим ресурсам AWS.
- _Configuration (конфигурация)_ - параметры памяти, времени выполнения, переменных окружения. Например, вы можете настроить функцию на использование 512 МБ памяти и максимальное время выполнения 30 секунд.

### Поддерживаемые языки программирования

AWS Lambda поддерживает широкий спектр популярных языков программирования, что позволяет разработчикам использовать уже знакомые технологии

Официально поддерживаемые языки (managed runtimes):

- _Python_ - версии 3.8, 3.9, 3.10, 3.11 и новее.
- _Node.js_ - версии 16.x, 18.x, 20.x, 22.x.
- _Java_ - версии 8, 11, 17.
- _Go_ - версия 1.x.
- _C# (.NET)_ - версии .NET 6, .NET 8.
- _Ruby_ - версия 2.7 и новее.
- _PowerShell_ - для автоматизации задач в Windows-окружении.

Помимо управляемых сред выполнения, Lambda предоставляет Runtime API, позволяющий использовать любой язык программирования, создав собственную среду выполнения. Это открывает возможности для использования языков, таких как Rust, PHP, или любых других.

Также Lambda поддерживает _развертывание функций как container images (образы контейнеров)_ размером до 10 ГБ, что дает еще больше гибкости в выборе зависимостей и окружения

### Модель оплаты AWS Lambda

AWS Lambda, как и другие сервисы AWS, использует модель оплаты "pay-as-you-go" (плати по мере использования). Вы _платите только за время, когда ваш код действительно выполняется_, а не за зарезервированные мощности.

Компоненты стоимости:

- _Количество запросов_. AWS взимает `$0.20` за _1 миллион запросов_. Первый 1 миллион запросов в месяц входит в бесплатный уровень (Free Tier).
- Время выполнения (compute time). Стоимость зависит от объема выделенной памяти и времени выполнения, измеряется в гигабайт-секундах (GB-s). Формула расчета:

  $Стоимость = (Объем памяти в ГБ) × (Время выполнения в секундах) × (Цена за GB-секунду)$.

Бесплатный уровень предоставляет _400,000 GB-секунд вычислительного времени в месяц_.

> С 1 августа 2025 года AWS начал включать в стоимость _время инициализации (INIT phase) для всех типов функций_. Это означает, что теперь вы платите не только за время выполнения вашего кода, но и за время подготовки окружения.

_Пример расчета стоимости_:

1. _Стоимость запросов:_

   $$
   (2{,}000{,}000 - 1{,}000{,}000\ \text{бесплатных}) \times \frac{\$0.20}{1{,}000{,}000} = \$0.20
   $$

2. _Стоимость вычислений:_

   $$
   \mathrm{Память\ в\ ГБ:}\ \frac{4512\ \mathrm{МБ}}{1024} = 0.5\ \mathrm{ГБ}
   $$

   $$
   \mathrm{GB\!-\!секунды\ на\ вызов:}\ 0.5\ \mathrm{ГБ}\times 0.2\ \mathrm{с} = 0.1\ \mathrm{GB\cdot s}
   $$

   $$
   \mathrm{Всего\ GB\!-\!секунд:}\ 2{,}000{,}000 \times 0.1 = 200{,}000\ \mathrm{GB\cdot s}
   $$

   $$
   \mathrm{Стоимость:}\ 200{,}000\ \mathrm{GB\cdot s} \le 400{,}000\ \mathrm{бесплатных\ GB\cdot s}\ \Rightarrow\ \$0.00
   $$

3. _*Итоговая стоимость:*_

   $$
   \boxed{\$0.20\ \mathrm{в\ месяц}}
   $$

## Источники событий для AWS Lambda

### Концепция триггеров и источников событий

Lambda-функции запускаются в ответ на события из различных источников.

_Источник события (event source)_ - это сервис AWS или приложение, которое генерирует события, способные вызвать выполнение Lambda-функции.

_Триггер (trigger)_ - это связка между событием и вашей Lambda-функцией. Когда привязанное к функции событие происходит, AWS автоматически вызовет соответствующую функцию и передаст ей данные события. Простыми словами, триггер - это механизм, который "слушает" определенные события и запускает функцию при их возникновении.

Существует два основных способа вызова Lambda-функций [^8]:

- _Push-модель (прямой вызов)_. Источник события непосредственно вызывает функцию, отправляя данные события. То есть, сторонний сервис напрямую "толкает" событие в Lambda. _Примеры_: S3, SNS, API Gateway.
- _Pull-модель (event source mapping)_. Lambda периодически опрашивает источник и извлекает события для обработки. То есть, сама Lambda “тянет” события из источника. _Примеры_: DynamoDB Streams, Kinesis, SQS.

_Событием может служить множество вещей_: загрузка файла, приход сообщения, запрос к API, изменение базы данных, расписание по времени и т. д. Lambda поддерживает интеграцию с десятками сервисов AWS в качестве источников событий. Ниже перечислены некоторые распространённые примеры триггеров Lambda-функций.

### Amazon S3 как источник событий

_Amazon S3_ - один из наиболее часто используемых триггеров для Lambda. Функция может быть автоматически вызвана при различных операциях с объектами в S3-корзине.

Распространённые типы событий S3, которые могут запускать Lambda-функции:

- `ObjectCreated:Put` - объект загружен с помощью PUT-запроса.
- `ObjectCreated:Post` - объект загружен с помощью POST-запроса.
- `ObjectCreated:Copy` - объект скопирован.
- `ObjectCreated:CompleteMultipartUpload` - завершена многочастная загрузка.
- `ObjectRemoved:Delete` - объект удален.
- `ObjectRemoved:DeleteMarkerCreated` - создан маркер удаления.

Пример события от S3:

```json
{
  "Records": [
    {
      "eventVersion": "2.1",
      "eventSource": "aws:s3",
      "awsRegion": "us-east-2",
      "eventTime": "2025-09-03T19:37:27.192Z",
      "eventName": "ObjectCreated:Put",
      "s3": {
        "bucket": {
          "name": "my-bucket",
          "arn": "arn:aws:s3:::my-bucket"
        },
        "object": {
          "key": "images/photo.jpg",
          "size": 1305107,
          "eTag": "b21b84d653bb07b05b1e6b33684dc11b"
        }
      }
    }
  ]
}
```

> При использовании одной и той же S3-корзины для входящих и исходящих файлов в Lambda-функции, убедитесь, что настроены правильные фильтры событий. В противном случае функция может создать бесконечный цикл вызовов, что приведет к неожиданным расходам. _Например_, обработанные файлы сохранять с другим префиксом или в отдельной корзине.

### DynamoDB Streams как источник событий

_DynamoDB Streams_ - это функция Amazon DynamoDB, которая позволяет отслеживать изменения в таблицах базы данных в реальном времени. Каждое изменение - вставка, обновление или удаление записи - создает событие в потоке [^9].

_Типы событий DynamoDB_:

- _INSERT_ - новая запись добавлена в таблицу.
- _MODIFY_ - существующая запись изменена.
- _REMOVE_ - запись удалена.

Lambda использует pull-модель для DynamoDB Streams: создается _event source mapping_, который опрашивает поток и вызывает функцию пакетами записей.

Примеры использования:

- _Синхронизация данных_. Репликация изменений в другую базу данных или поисковый индекс. Например, при добавлении нового пользователя в DynamoDB автоматически создается профиль в _Elasticsearch_ (база данных, специально оптимизированная для поиска).
- _Аудит_. Запись всех изменений в отдельную таблицу для аудита и соответствия требованиям.
- _Агрегация_. Подсчет метрик в реальном времени на основе изменений данных.
- _Уведомления_. Отправка уведомлений пользователям при изменении их данных. Например, при обновлении статуса заказа отправляется email клиенту.

### API Gateway

_API Gateway_ - это управляемый сервис для создания, публикации, защиты и управления _RESTful API_ и _WebSocket API._ Он позволяет создать HTTP-эндпоинт, который вызывает Lambda-функцию.

Когда клиент отправляет HTTP-запрос к API Gateway:

- API Gateway проверяет запрос, применяет авторизацию и валидацию.
- Преобразует запрос в событие JSON.
- Синхронно вызывает Lambda-функцию.
- Получает ответ от функции и возвращает его клиенту.

Это идеальное решение для создания serverless REST API для веб и мобильных приложений.

### SQS, SNS

_Amazon Simple Notification Service (SNS)_ и _Amazon Simple Queue Service (SQS)_ - это сервисы обмена сообщениями, которые часто используются как промежуточный слой между источниками событий и Lambda-функциями.

- _SNS_ - это pub/sub сервис, который позволяет отправлять сообщения нескольким подписчикам одновременно. Lambda-функция может быть подписчиком на тему SNS и будет вызываться при публикации нового сообщения.

- _SQS_ - это сервис очередей сообщений, который позволяет надежно передавать сообщения между компонентами системы. Lambda-функция может быть настроена на опрос очереди SQS и обработку сообщений по мере их поступления.

### Другие сервисы

AWS Lambda интегрируется с множеством других сервисов AWS, которые могут выступать в роли источников событий:

- _CloudWatch Events / EventBridge_. Запуск функций по расписанию или в ответ на системные события.
- _Kinesis_. Обработка потоковых данных в реальном времени.
- _Alexa Skills Kit_. Создание голосовых приложений для устройств Alexa.
- _Elastic Load Balancing (ELB)_. Обработка запросов от балансировщиков нагрузки.

### Вызов через SDK, CLI и Console

Помимо автоматических триггеров, Lambda-функции можно вызывать программно:

- _AWS SDK_ - из кода приложения на различных языках программирования
- _AWS CLI_ - из командной строки для тестирования и автоматизации.
- _AWS Console_ - через веб-интерфейс для ручного тестирования.

_Пример вызова через AWS CLI_:

```bash
aws lambda invoke \
  --function-name my-function \
  --payload '{"key": "value"}' \
  response.json
```

_Пример вызова через Node.js SDK_:

```javascript
const { LambdaClient, InvokeCommand } = require("@aws-sdk/client-lambda");

const client = new LambdaClient({ region: "us-east-1" });

const params = {
  FunctionName: "my-function",
  Payload: JSON.stringify({ key: "value" }),
};

const command = new InvokeCommand(params);
const response = await client.send(command);
const result = JSON.parse(Buffer.from(response.Payload).toString());
console.log(result);
```

## Конфигурация функций AWS Lambda

При разработке _Lambda-функций важно понимать параметры их конфигурации_ – от этого зависят возможности и ограничения функции. Рассмотрим основные аспекты настройки Lambda-функции: подключение внешних зависимостей, использование слоёв, а также ресурсы и параметры выполнения (память, время, переменные и др.).

### Компоненты функции

Каждая Lambda-функция состоит из нескольких ключевых компонентов:

- _Function Code (код функции)_ - ваша бизнес-логика, написанная на одном из поддерживаемых языков.
- _Dependencies (зависимости)_ - внешние библиотеки и модули, необходимые для работы кода.
- _Execution Environment (окружение выполнения)_ - runtime, конфигурация памяти, переменные окружения. Например, python 3.9 с 512 МБ памяти.
- _Execution Role (роль выполнения)_ - IAM-роль, определяющая разрешения функции на доступ к другим AWS-сервисам. То есть, какие действия функция может выполнять Lambda. Например, доступ к созданию объектов в S3 или чтению из DynamoDB.

### Код функции и зависимости

Код Lambda-функции можно загружать несколькими способами:

- _Прямое редактирование в AWS Console_. Подходит для небольших функций. В AWS Console доступен встроенный редактор кода, где можно писать и тестировать функции на Python, Node.js и других языках.
- _Загрузка ZIP-архива_. Для более сложных функций с зависимостями вы можете упаковать код и все необходимые библиотеки в ZIP-файл и загрузить его через консоль, CLI или SDK.
- _Использование контейнерных образов_. Lambda поддерживает развертывание функций в виде Docker-образов размером до 10 ГБ.

Кроме основного кода, функции часто требуют внешних библиотек. Например, для Node.js это могут быть модули из npm, для Python - пакеты из PyPI. Эти зависимости также должны быть включены в пакет развертывания. Однако есть ограничение на размер: _развернутый код функции (включая зависимости) не должен превышать ~250 МБ_ в распакованном виде.

_Пример структуры проекта для Node.js_:

```
my-function/
├── index.js
├── package.json
└── node_modules/
    ├── express/
    └── lodash/
```

### Название функции в коде

В коде Lambda-функции важно правильно указать точку входа - _handler_.

_Handler_ - это метод, который AWS Lambda вызывает для начала выполнения вашего кода. Формат указания handler зависит от выбранного runtime.

_Пример для Node.js_:

```js
// index.js
exports.handler = async (event, context) => {
  // Ваш код здесь
};
```

_Пример для Python_:

```python
# lambda_function.py
def lambda_handler(event, context):
    # Ваш код здесь
```

_Пример для Java_:

```java
public class Handler implements RequestHandler<Map<String,String>, String> {
    @Override
    public String handleRequest(Map<String,String> event, Context context) {
        // Ваш код здесь
    }
}
```

Именно данный метод (handler) будет вызван при срабатывании триггера.

### Слои AWS Lambda (AWS Lambda Layers)

_Lambda Layers (слои)_ - это механизм для упаковки и распространения библиотек, зависимостей и другого кода между несколькими Lambda-функциями.

Представьте, что у вас есть 10 Lambda-функций, которые используют одну и ту же библиотеку для работы с изображениями. Без layers вам нужно включить эту библиотеку в каждую функцию, что увеличивает размер пакета и усложняет обновление. С layers вы создаете один слой с библиотекой и подключаете его ко всем функциям.

Преимущества использования layers:

- _Переиспользование кода_. Один слой может использоваться множеством функций.
- _Уменьшение размера пакета_. Основной код функции остается компактным.
- _Упрощение управления зависимостями_. Обновление библиотеки в слое автоматически применяется ко всем функциям.
- _Организация кода_. Разделение бизнес-логики и зависимостей.

_Структура layer_ :

```
my-layer.zip
└── nodejs/
    └── node_modules/
        ├── axios/
        └── lodash/
```

Каждая функция может использовать до 5 слоев.

Один слой _может иметь несколько библиотек и зависимостей_, что позволяет создавать комплексные среды выполнения.

### Создание Lambda-функции через AWS Console

Рассмотрим процесс создания Lambda-функции через веб-интерфейс AWS.

#### Шаг 1. Имя функции

Первое, что нужно сделать - задать уникальное имя функции. Имя должно быть описательным и отражать назначение функции. _Например_: `image-thumbnail-generator`, `user-auth-handler`, `order-processor`. Часто функции называют еще с указанием среды, версии и региона, например: `prod-us-east-1-user-auth-v1`.

#### Шаг 2. Выбор runtime

_Runtime_ определяет язык программирования и его версию, которые будут использоваться для выполнения кода. Выберите runtime, соответствующий языку, на котором написана ваша функция.

#### Шаг 3. Шаг 3. Execution Role (роль выполнения)

_Execution role_ - это IAM-роль, которую Lambda принимает (assumes) при выполнении функции. Роль определяет, к каким AWS-ресурсам функция имеет доступ.

Например, если ваша функция должна:

- Читать объекты из S3 - роль должна иметь разрешение `s3:GetObject`.
- Записывать данные в DynamoDB - разрешение `dynamodb:PutItem`.
- Отправлять логи в CloudWatch - разрешение из политики `AWSLambdaBasicExecutionRole`.

При создании функции через консоль AWS предлагает три варианта:

- _Create a new role with basic Lambda permissions_ - AWS автоматически создаст роль с базовыми правами для записи логов.
- _Use an existing role_ - выбрать уже созданную роль с нужными разрешениями.
- _Create a new role from AWS policy templates_ - создать роль на основе шаблонов, например, для доступа к S3 бакету.

> Следуйте принципу наименьших привилегий (principle of least privilege): предоставляйте функции только те разрешения, которые действительно необходимы для ее работы.

#### Шаг 4. Триггер

После создания функции необходимо настроить триггер - источник событий, который будет вызывать функцию.

В разделе "Add trigger" выберите один из доступных источников:

- _S3_ - для обработки загрузок и изменений файлов.
- _DynamoDB_ - для реагирования на изменения в таблице.
- _EventBridge (CloudWatch Events)_ - для запуска по расписанию или пользовательским событиям.
- _API Gateway_ - для обработки HTTP-запросов.

#### Шаг 5. Function Code

Раздел Function Code содержит редактор кода, где вы можете написать или загрузить код вашей функции.

Пример простой функции на Node.js:

```js
exports.handler = async (event, context) => {
  console.log("Event:", JSON.stringify(event, null, 2));

  const response = {
    statusCode: 200,
    body: JSON.stringify({
      message: "Hello from Lambda!",
      input: event,
    }),
  };

  return response;
};
```

#### Шаг 6. Memory

Память, выделяемая функции, настраивается в диапазоне от 128 МБ до 10,240 МБ. Важно понимать, что увеличение памяти также пропорционально увеличивает выделяемую CPU-мощность.

Как выбрать правильный объем памяти:

- Начните с 128-256 МБ для простых функций.
- Постепенно увеличивайте, если функция превышает лимит памяти или работает слишком медленно.
- Используйте инструменты профилирования для оптимизации.
- Используйте инструменты профилирования для оптимизации.Помните, что большая память = больше CPU = быстрее выполнение, но и выше стоимость.

#### Шаг 7. Environment Variables

_Переменные окружения_ позволяют настраивать поведение функции без изменения кода. Это особенно полезно для хранения конфигурационных параметров, которые различаются между окружениями (dev, staging, production).

Примеры использования:

- Строки подключения к базам данных: `DB_HOST`, `DB_NAME`.
- API ключи: `API_KEY`, `SECRET_TOKEN`.
- Уровни логирования: `LOG_LEVEL`.

_Пример доступа к переменным окружения в коде_:

```js
const dbHost = process.env.DB_HOST;
const apiKey = process.env.API_KEY;
```

> Не храните чувствительные данные (пароли, ключи доступа) в переменных окружения в открытом виде. Используйте AWS Secrets Manager для безопасного хранения секретов.

#### Шаг 8. Загрузка функции и зависимостей

Для небольших функций (до нескольких мегабайт) можно использовать встроенный редактор в консоли. Для более сложных проектов существует несколько способов загрузки, которые были рассмотрены ранее:

- ZIP-архив.
- Container Image.
  - Создайте Docker-образ с кодом функции и всеми зависимостями.
  - Загрузите образ в Amazon ECR (Elastic Container Registry).
  - Настройте функцию для использования образа из ECR.
  - Максимальный размер образа: 10 ГБ.

_Пример Dockerfile для Node.js Lambda-функции_:

```Dockerfile
FROM public.ecr.aws/lambda/nodejs:18

COPY app.js package.json ./

RUN npm install

CMD ["app.handler"]
```

## Ограничения AWS Lambda

AWS Lambda имеет два типа ограничений:

- _Soft limits (мягкие ограничения)_ - это лимиты по умолчанию, которые можно увеличить, обратившись в AWS Support с запросом на повышение квоты.
- _Hard limits (жесткие ограничения)_ - это неизменяемые лимиты, установленные платформой AWS.

### Soft Limits

- _Concurrent executions (одновременные выполнения)_. По умолчанию: 1,000 на регион. Это означает, что в одном регионе может одновременно выполняться не более 1,000 экземпляров всех ваших Lambda-функций вместе взятых. При достижении лимита новые вызовы будут троттлиться (throttled) [^10].
- _Function and layer storage (хранилище функций и слоев)_. По умолчанию: 75 ГБ на регион. Это общий объем хранилища для всех версий функций и слоев в регионе.

Эти лимиты можно увеличить через AWS Support Center, предоставив обоснование необходимости.

### Hard Limits

- _Maximum memory allocation (максимальная выделяемая память)_. 10,240 МБ (10 ГБ). Вы не можете выделить функции больше памяти, даже если это необходимо для выполнения задачи.
- _Function timeout (максимальное время выполнения)_. 15 минут (900 секунд). Это абсолютный максимум. Вы можете установить меньшее значение (по умолчанию 3 секунды), но не больше 15 минут. Если функция выполняется дольше, она будет принудительно завершена.
- _Deployment package size (размер пакета развертывания)_:
  - ZIP-архив: 50 МБ (прямая загрузка), 250 МБ (распакованный, включая layers).
  - Container image: 10 ГБ
- _Environment variables_. Общий размер всех переменных окружения: 4 КБ.
- _Request and response payload_. 6 МБ для синхронного вызова, 256 КБ для асинхронного.

> Если вашей задаче требуется более 15 минут на выполнение, рассмотрите альтернативные решения: _AWS Step Functions_ для оркестрации длительных workflow, _AWS Batch_ для пакетной обработки, или _EC2/ECS_ для долгоживущих процессов.

## AWS Lambda vs Amazon EC2

### Различия и сценарии использования

Когда следует использовать Lambda, а когда - традиционные EC2 инстансы? Это один из ключевых вопросов при проектировании облачных приложений. Давайте рассмотрим сравнение этих двух подходов.

| Аспект                        | AWS Lambda                           | Amazon EC2                                  |
| ----------------------------- | ------------------------------------ | ------------------------------------------- |
| Модель управления             | Полностью управляемая, без серверов  | Виртуальные серверы, требующие управления   |
| Масштабирование               | Автоматическое, мгновенное           | Требует настройки _Auto Scaling_            |
| Оплата                        | За время выполнения (миллисекунды)   | За время работы инстанса (часы)             |
| Максимальное время выполнения | 15 минут                             | Неограниченно                               |
| Состояние                     | Stateless (без сохранения состояния) | Stateful (может сохранять состояние)        |
| Холодный старт                | 100-1000 мс                          | Отсутствует (сервер всегда работает)        |
| Максимальная память           | 10,240 МБ                            | До сотен ГБ, в зависимости от типа инстанса |
| Контроль над окружением       | Ограниченный                         | Полный                                      |

Lambda является оптимальным выбором в следующих сценариях:

- _Обработка событий_. Когда задача запускается в ответ на событие - загрузку файла в S3, изменение в DynamoDB, HTTP-запрос через API Gateway.
- _Непредсказуемая или переменная нагрузка_. Lambda автоматически масштабируется от нуля до тысяч одновременных выполнений, и вы платите только за фактическое использование.
- _Короткие задачи_. Функции, выполняющиеся от миллисекунд до нескольких минут - обработка API-запросов, трансформация данных, генерация миниатюр изображений.
- _Микросервисная архитектура_. Каждый микросервис может быть реализован как отдельная Lambda-функция, что упрощает разработку и развертывание.
- _Экономия на простаивающих ресурсах_. Если ваше приложение получает запросы нерегулярно, Lambda позволяет не платить за время простоя.

_Пример из реальной жизни_: интернет-магазин получает заказы неравномерно в течение дня. В пиковые часы (вечер, выходные) количество заказов может увеличиваться в 10 раз. Lambda автоматически масштабируется для обработки всех заказов, а в периоды низкой активности вы не платите за неиспользуемые ресурсы.

В то время, как Amazon EC2 подходит для следующих случаев:

- _Длительные процессы_. Задачи, выполняющиеся более 15 минут (например, обучение моделей машинного обучения, длительные вычисления).
- _Постоянная высокая нагрузка_. Если приложение получает стабильный трафик 24/7, Reserved Instances EC2 могут быть экономически выгоднее.
- _Stateful-приложения_. Когда необходимо сохранять состояние между запросами (например, игровые серверы, сессии пользователей).
- _Требования к производительности_. Когда критична минимальная задержка и холодный старт Lambda неприемлем.
- _Полный контроль_. Когда требуется настройка операционной системы, сетевой конфигурации или специфического ПО.

### Гибридный подход

Многие современные приложения используют гибридный подход:

- _Часть функционала реализуется с помощью AWS Lambda_ - например, обработка API-запросов или событий от S3 и DynamoDB.
- _Другая часть работает на EC2_ - например, длительные фоновые процессы, базы данных или сервисы с постоянной нагрузкой.

Часто основное приложение разворачивается на EC2, а отдельные задачи выносятся в Lambda, если они выполняются нерегулярно, требуют быстрого масштабирования или хорошо подходят под безсерверную архитектуру.

_Типичный сценарий_:

- Веб-приложение интернет-магазина работает на EC2 - оно отвечает за каталог товаров, корзину и оформление заказов.
- Когда пользователь оформляет заказ, создаётся событие, которое вызывает Lambda-функцию: она отправляет письмо с подтверждением, сохраняет счёт в S3 и обновляет статус в базе данных. При загрузке нового изображения товара - ещё одна Lambda автоматически создаёт миниатюру и добавляет её в каталог.

Такой подход позволяет комбинировать стабильную работу основного сайта с гибкостью и экономичностью безсерверных функций.

[^1]: _What is Serverless Computing? Examples, Pros & Cons, & Future Trends_. aimconsulting.com [online]. Available at: https://aimconsulting.com/insights/serverless-computing-examples-pros-cons-kubernetes-trends/
[^2]: _AWS Lambda_. aws.amazon.com [online]. Available at: https://aws.amazon.com/lambda/
[^3]: _Что такое бессерверные вычисления_. colobridge.com [online]. Available at: https://blog.colobridge.net/2024/01/serverless-computing/
[^4]: _Serverless on AWS_. aws.amazon.com [online]. Available at: https://aws.amazon.com/serverless/
[^5]: _What Is AWS Lambda? A Beginner’s Guide to Serverless in 2025_. cloudthat.com [online]. Available at: https://www.cloudthat.com/resources/blog/what-is-aws-lambda-a-beginners-guide-to-serverless-in-2025
[^6]: _Resilience in AWS Lambda_. docs.aws.amazon.com [online]. Available at: https://docs.aws.amazon.com/lambda/latest/dg/security-resilience.html
[^7]: _How much is AWS Lambda?_. modal.com [online]. Available at: https://modal.com/blog/aws-lambda-price-article
[^8]: _Creating event-driven architectures with Lambda_. docs.aws.amazon.com [online]. Available at: https://docs.aws.amazon.com/lambda/latest/dg/concepts-event-driven-architectures.html
[^9]: _DynamoDB Streams and AWS Lambda triggers_. docs.aws.amazon.com [online]. Available at: https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Streams.Lambda.html
[^10]: _AWS Lambda Timeout Best Practices_. lumigo.io [online]. Available at: https://lumigo.io/aws-lambda-performance-optimization/aws-lambda-timeout-best-practices/
