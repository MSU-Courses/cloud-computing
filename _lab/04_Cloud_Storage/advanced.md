# Вариант B: Object Ownership Enforced (без ACL)

В этом варианте студент выполняет создание бакета с использованием современной модели доступа AWS S3, где ACL полностью отключены.

Все разрешения на доступ реализуются через _Bucket Policy_ и IAM-пользователя.

Это тот подход, который используется в реальных корпоративных проектах:
он безопаснее, масштабируемее и лучше контролируется через централизованные политики.

## Шаг 1. Создание бакетов без ACL

_Публичный бакет_:

1. Перейдите в AWS Console → S3 → Create bucket.
2. Задайте:
   1. Имя: `cc-lab4-pub-kXX`
   2. Регион: `eu-central-1`
   3. Object Ownership: выберите `Bucket owner enforced (ACLs disabled)`
   4. Block all public access: пока оставьте включённым
   5. Нажмите `Create bucket`

_Приватный бакет_:

Повторите шаги для второго бакета, за исключением имени: `cc-lab4-priv-kXX`.

После создания у вас есть:

- Публичный бакет: `cc-lab4-pub-kXX`
- Приватный бакет: `cc-lab4-priv-kXX`

В этом режиме все объекты принадлежат владельцу бакета, а ACL полностью игнорируются. Управление доступом выполняется через _IAM_ и _Bucket Policy_.

## Шаг 2. Создание IAM-пользователя и выдача прав

В этом варианте мы создаём отдельного пользователя AWS (`s3-uploader`) и даём ему минимальные права работы с нашими бакетами.

Это иллюстрирует, как в AWS разделяют роли и _принципы минимально необходимых прав (Least Privilege)_.

### Шаг 2.1. Создание пользователя

1. Перейдите в IAM → Users → Create user.
2. Создайте пользователя с именем `s3-uploader`.
3. Console access не включайте.
   1. Данному пользователю не нужен доступ в консоль, так как он будет работать только через API (CLI/SDK).
4. На странице пользователя → вкладка Security credentials → Create access key.
   1. Тип доступа: Command Line Interface (CLI).
   2. Скопируйте Access key ID и Secret access key (понадобятся для CLI).

Такой пользователь используется для автоматизации (CLI, PHP SDK, Python boto3). _Ключи аутентификации_ позволяют безопасно взаимодействовать с AWS-программно,
без использования root-доступа.

### Шаг 2.2. Создание IAM-политики (минимальные права)

_Политика_ - это JSON-документ, который определяет, какие действия разрешены или запрещены для пользователя.

Наша цель: дать пользователю `s3-uploader` права на загрузку и чтение объектов в _публичном бакете_ и только чтение в _приватном бакете_.

1. Перейдите в IAM → Policies → Create policy → JSON.
2. Вставьте следующий JSON, заменив `kXX` на ваш идентификатор:

   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Sid": "ListOnlyTheseBuckets",
         "Effect": "Allow",
         "Action": ["s3:ListBucket"],
         "Resource": [
           "arn:aws:s3:::cc-lab4-pub-kXX",
           "arn:aws:s3:::cc-lab4-priv-kXX"
         ]
       },
       {
         "Sid": "ReadWritePublicBucketLimited",
         "Effect": "Allow",
         "Action": ["s3:GetObject", "s3:PutObject", "s3:DeleteObject"],
         "Resource": "arn:aws:s3:::cc-lab4-pub-kXX/*"
       },
       {
         "Sid": "LogsRWButOnlyUnderLogsPrefix",
         "Effect": "Allow",
         "Action": ["s3:GetObject", "s3:PutObject", "s3:DeleteObject"],
         "Resource": "arn:aws:s3:::cc-lab4-priv-kXX/logs/*"
       }
     ]
   }
   ```

   _При создании политики обратите внимание на следующие моменты_:

   - `Version`: версия языка политики, оставьте как есть.
   - `Statement`: массив правил.
   - `Effect`: действие правила - `Allow` (разрешить) или `Deny` (запретить).
   - `Action`: список разрешённых действий (например, `s3:PutObject` для загрузки объектов).
   - `Resource`: _ARN (Amazon Resource Name)_ ресурсов, к которым применяется правило. _ARN_ - это уникальный идентификатор ресурса в AWS, каждый ресурс имеет свой ARN. В данном случае, данные правила применяются к нашим бакетом. То есть это значит, что пользователь сможет выполнять указанные действия только с этими бакетами.

   Данная политика позволяет следующее:

   | Раздел                       | Назначение                                             | Объяснение                                                                                       |
   | ---------------------------- | ------------------------------------------------------ | ------------------------------------------------------------------------------------------------ |
   | ListOnlyTheseBuckets         | Разрешает команду `ListBucket` только для двух бакетов | Без неё пользователь не сможет увидеть содержимое бакета                                         |
   | ReadWritePublicBucketLimited | Полный доступ к публичному бакету                      | Пользователь может загружать, читать и удалять объекты                                           |
   | LogsRWButOnlyUnderLogsPrefix | Даёт доступ только к logs/ внутри приватного бакетаю   | Пример принципа “минимальных прав”: пользователь не может выйти за пределы разрешённого префикса |

3. Нажмите `Next: Tags` → `Next: Review`.
4. Задайте имя политики, например, `S3UploaderPolicy`, и нажмите `Create policy`.

### Шаг 2.3. Привязка политики к пользователю

1. Перейдите в `IAM` → `Users` → `s3-uploader` → `Permissions` → `Add permissions`.
2. Выберите Attach policies directly.
3. Найдите и выберите созданную ранее политику `S3UploaderPolicy`.
4. Нажмите `Next: Review` → `Add permissions`.
5. Теперь пользователь `s3-uploader` имеет необходимые права для работы с нашими бакетами.

Только теперь пользователь получает доступ к S3. До этого момента AWS по умолчанию всё запрещает ("_deny by default_").

## Шаг 3. Разрешение чтения из публичного бакета

Чтобы сделать файлы в _публичном бакете_ доступными для всех (например, для отображения аватаров на сайте), нам нужно создать _Bucket Policy_, которая разрешит публичный доступ на чтение.

1. В публичном бакете отключите защиту:
   1. Permissions → Block public access (BPA) → снимите “Block all public access” → Save.
2. Ниже откройте Bucket policy → Edit и вставьте:

   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Sid": "AllowPublicRead",
         "Effect": "Allow",
         "Principal": "*",
         "Action": "s3:GetObject",
         "Resource": [
           "arn:aws:s3:::cc-lab4-pub-kXX/avatars/*",
           "arn:aws:s3:::cc-lab4-pub-kXX/content/*"
         ]
       }
     ]
   }
   ```

   _В данном случае_:

   - `Principal: "*"` означает, что любой пользователь Интернета может читать объекты (но не изменять).
   - `Action: s3:GetObject` - разрешено только чтение.
   - `Resource` - указаны префиксы (папки) `avatars/` и `content/`, доступные для чтения.

3. Сохраните изменения.

Теперь файлы внутри `avatars/` и `content/` будут доступны публично по URL.

## Шаг 4. Проверка работы

1. Установите и настройте AWS CLI на вашем компьютере, используя ключи пользователя `s3-uploader`.
2. Попробуйте залить файл в публичный бакет.

## Возвращайтесь ...

Теперь, когда вы настроили бакеты и права доступа, вы можете вернуться к основному сценарию лабораторной работы.

[Вернуться к основному сценарию лабораторной работы](./readme.md)
