# Лабораторная работа №4. Облачное хранилище данных. Amazon S3

## Цель работы

Целью работы является познакомиться с сервисом Amazon S3 (Simple Storage Service) и отработать основные операции:

- создание публичного и приватного бакетов;
- загрузку и организацию объектов;
- работу с S3 через AWS CLI (копирование, перемещение, синхронизация);
- настройку версионирования и шифрования;
- использование S3 Static Website Hosting;
- применение Lifecycle-правил для архивирования старых данных.

После выполнения работы студент:

- понимает концепцию объектного хранилища и его отличия от блочного и файлового;
- умеет создавать и настраивать бакеты в Amazon S3;
- владеет навыками загрузки и управления объектами через консоль и CLI;
- знает, как настроить статический веб-хостинг на базе S3;
- понимает принципы версионирования и жизненного цикла объектов в S3.

## Условие

_Amazon S3_ — это объектное хранилище AWS, предназначенное для хранения файлов любого типа: изображений, резервных копий, документов, логов и т.д. Каждый объект хранится внутри _бакета_ (bucket) и имеет _уникальный ключ_ (key). "Папки" в консоли — это лишь префиксы ключей, а не настоящие директории.

В этой лабораторной вы создадите два бакета:

- _Публичный бакет_ - для хранения аватаров пользователей и статического контента;
- _Приватный бакет_ - для логов и служебных файлов (с Lifecycle-политикой).

### Шаг 1. Подготовка

1. Регион: `eu-central-1` (Frankfurt).
2. Формат имён бакетов:
   1. _Публичный_: `cc-lab4-pub-kXX`
   2. _Приватный_: `cc-lab4-priv-kXX`
3. Локально (на своем компьютере) создайте структуру каталогов и файлов, как показано ниже:

   ```
   s3-lab/
    ├── public/
    │   ├── avatars/
    │   │   ├── user1.jpg
    │   │   └── user2.jpg
    │   └── content/logo.png
    ├── private/
    │   └── logs/
    │       └── activity.csv
    └── README.md
   ```

   > Данные файлы в дальнейшем будут загружены в соответствующие бакеты.

### Шаг 2. Создание бакетов

На данном шаге студент может выбрать один из способов создания бакетов:

- использовать ACL (упрощённый, наглядный),
- использовать Object Ownership Enforced (современный, безопасный).
  - [Ссылка на данный вариант](./advanced.md)

> Чем отличаются два способа управления доступом к бакетам в S3?

В данном гайде описан первый способ (с использованием ACL).

Перейдите в консоль управления AWS S3 и создайте два бакета с указанными именами.

_Публичный бакет_:

1. Имя: `cc-lab4-pub-kXX`
2. Region: `eu-central-1`
3. Object Ownership: ACLs enabled (Can be configured using ACLs)
4. _Block all public access_: снять галочку (разрешить публичность)
5. Подтвердите предупреждение
6. Нажмите `Create bucket`

> Что означает опция “Block all public access” и зачем нужна данная настройка?

Аналогично создайте _Приватный бакет_ с именем `cc-lab4-priv-kXX`, но оставьте все настройки по умолчанию (_Block all public access — включен_).

> Режим ACLs enabled позволяет управлять доступом к каждому объекту отдельно (например, сделать одну картинку публичной, а другую — приватной). Это удобно для лабораторных экспериментов и визуально понятно студентам.

### Шаг 3. Загрузка объектов через AWS Management Console

1. Перейдите в бакет `cc-lab4-pub-kXX`.
2. Перейдите в директорию `avatars/` и нажмите `Upload`.
3. Загрузите файл `user1.jpg` из локальной папки `s3-lab/public/avatars/`.
4. После загрузки в пункте `Permissions` выберите `Grant public-read access`.
5. Завершите загрузку нажав `Upload`.

> Чем отличается ключ (object key) от имени файла?

### Шаг 4. Загрузка объектов через AWS CLI

1. Установите и настройте AWS CLI, если это не сделано ранее.
2. Выполните команду для загрузку файла `user2.jpg` в публичный бакет:

   ```bash
   aws s3 cp s3-lab/public/avatars/user2.jpg s3://cc-lab4-pub-kXX/avatars/user2.jpg --acl public-read
   ```

3. Загрузите файл `logo.png` в публичный бакет, в директорию `content/`, также сделав его публичным.
4. Загрузите файл `activity.csv` в приватный бакет, не делая его публичным.

> В чём разница между командами aws s3 `cp`, `mv` и `sync` и для чего используется параметр флаг `--acl public-read`?

### Шаг 5. Проверка доступа к объектам

1. Откройте в браузере URL загруженного публичного объекта:

   ```
   https://cc-lab4-pub-kXX.s3.eu-central-1.amazonaws.com/avatars/user1.jpg
   ```

   Вы должны увидеть изображение.

2. Попробуйте открыть URL загруженного приватного объекта, он должен быть недоступен.

### Шаг 6. Версионирование объектов

Включите версионирование для обоих бакетов через вкладку `Properties` → `Bucket Versioning` → `Enable`.

1. Измените файл `logo.png` и загрузите его заново, чтобы увидеть создание новой версии.
2. Посмотрите вкладку `Versions`, там будут отображаться все версии объекта.

> Что произойдёт, если выключить версионирование после его включения?

### Шаг 7. Создание Lifecycle-правил для приватного бакета

1. В приватном бакете зайдите в `Management` → `Lifecycle rules` → `Create rule`.
   1. Имя: `logs-archive`
   2. Префикс: `logs/`
   3. Actions:
      1. `Transition → Standard-IA` через 30 дней
      2. `Transition → Glacier Deep Archive` через 365 дней
      3. `Expiration → удалить` через 1825 дней (5 лет)
2. Сохраните правило: `Create rule`.

> Что такое Storage Class в Amazon S3 и зачем они нужны?

Так вы автоматизируете хранение логов: старые файлы будут автоматически архивироваться.

### Шаг 8. Создание статического веб-сайта на базе S3

Создайте бакет `cc-lab4-web-kXX` для хостинга статического сайта:

1.  Имя: `cc-lab4-web-kXX`
2.  Region: `eu-central-1`
3.  Object Ownership: ACLs enabled (Can be configured using ACLs)
4.  _Block all public access_: снять галочку (разрешить публичность)
5.  Нажмите `Create bucket`

После создания настройте хостинг:

1. Перейдите в бакет → вкладка `Properties` → `Static website hosting` → `Edit` -> `Enable`.
2. Выберите следующие параметры:

   1. _Hosting type_: `Host a static website`.
   2. _Index document_: `index.html`.

3. Проанализируйте веб-сайт, прикрепленный к данной лабораторной работе: [веб-сайт](./web/)
4. Скопируйте файлы веб-сайта в бакет `cc-lab4-web-kXX`. _Не забудьте сделать файлы публичными!_
5. Откройте URL статического сайта, указанный в настройках S3.

С помощью S3 можно быстро и просто развернуть статический сайт без необходимости использования серверов. Например, если у вас есть React-приложение, его собранные файлы можно загрузить в такой бакет для хостинга.

> Несмотря на удобство, для серьёзных проектов рекомендуется использовать специализированные сервисы хостинга (например, AWS Amplify), которые предоставляют дополнительные возможности.

### Шаг 9. Дополнительное задание. Загрузка файлов через AWS SDK

Дан небольшой скрипт на PHP, который позволяет загружать файлы в S3 через веб-форму.

_Форма для загрузки файла (`upload.php`)_

```html
<!-- index.php -->
<form action="upload.php" method="post" enctype="multipart/form-data">
  Select file to upload:
  <input type="file" name="fileToUpload" id="fileToUpload" />
  <input type="submit" value="Upload File" name="submit" />
</form>
```

_Обработчик загрузки файла (`upload.php`)_

```php
<?php

// upload.php

require 'vendor/autoload.php';

use Aws\S3\S3Client;

define('BUCKET_NAME', 'bucket-name');

$s3 = new S3Client([
    'region'  => 'us-central-1',
]);

// Получение файла из формы
$file = $_FILES['fileToUpload']['tmp_name'];
$filename = $_FILES['fileToUpload']['name'];

// Поместить в "папку" avatars (S3 использует префиксы в ключах)
$destinationKey = 'avatars/' . basename($filename);

// Загрузка файла в S3
try {
    $result = $s3->putObject([
        'Bucket'     => BUCKET_NAME,
        'Key'        => $destinationKey,
        'SourceFile' => $file,
        'ACL'        => 'public-read', // Сделать файл публичным
    ]);

    echo "File uploaded successfully. URL: " . $result['ObjectURL'];
} catch (Aws\Exception\AwsException $e) {
    echo "Error uploading file: " . $e->getMessage();
}
```

_Добавьте следующую функциональность_:

1. При загрузке аватара, поменяйте имя файла на уникальное (например, добавьте временную метку или UUID), чтобы избежать конфликтов имён.
2. Добавьте базу данных (рекомендуется _SQLite_) для хранения информации о загруженных файлах (оригинальное имя, новое имя, URL, дата загрузки).
3. Выведите список всех загруженных файлов на отдельной странице.

## Контрольные вопросы

Контрольные вопросы указаны выше в некоторых заданиях. Ответьте на них письменно во время выполнения лабораторной работы.

## Правила предоставления лабораторной работы

Необходимо написать отчёт по лабораторной работе. Отчет может быть предоставлен в 2 форматах:

- В формате PDF (Word). Максимальная оценка - _8_.
- Файл README.md, то есть в формате Markdown. Максимальная оценка - _10_.

### Отчет в формате Word (PDF) файла

1. Титульный лист
2. Теоретическая часть
   1. Формулировка задачи
   2. Описание цели и основные этапы работы
3. Практическая часть
   1. Пошаговое описание выполнения работы с пояснениями и скриншотами.
   2. Ответы на контрольные вопросы (можно включить прямо в описание шагов)
4. Вывод
5. Список использованных источников

### Отчет в формате Markdown (README.md)

1. Описание лабораторной работы
   1. Постановка задачи
   2. Цель и основные этапы работы
2. Практическая часть
   1. Пошаговое описание выполнения лабораторной работы с пояснениями и скриншотами
   2. Ответы на контрольные вопросы (можно включить прямо в описание шагов)
3. Список использованных источников
4. Вывод
5. Дополнительные важные аспекты, если применимо

## Представление лабораторной работы

Представление лабораторной работы обязательно. В случае отсутствия представления лабораторной работы, максимальная оценка составит 7 при выполнении всех условий.

_Если при защите лабораторной работы студент не отвечает на вопросы преподавателя, итоговая оценка может быть ниже 7_.
